# 数据库配置指南

## 如何查看阿里云数据库连接信息

### 方法一: 通过阿里云控制台查看 (推荐)

1. **登录阿里云控制台**
   - 访问 https://www.aliyun.com/
   - 使用您的阿里云账号登录

2. **进入数据库管理页面**
   - 在顶部搜索栏搜索 "RDS" 或 "数据库"
   - 或者从左侧菜单找到 "云数据库 RDS" 或 "云数据库 PolarDB"
   - 确认区域是 "华北2(北京)" (与您的ECS在同一区域)

3. **选择数据库实例**
   - 在实例列表中找到您创建的数据库实例
   - 点击实例ID进入详情页

4. **查看连接信息**
   - 在"基本信息"页面可以看到:
     * **数据库类型**: MySQL 或 PostgreSQL
     * **内网地址**: 类似 `rm-xxxxx.mysql.rds.aliyuncs.com`
     * **公网地址**: 类似 `rm-xxxxx.mysql.rds.aliyuncs.com` (如果开启了公网访问)
     * **端口**: 通常是 3306(MySQL) 或 5432(PostgreSQL)

   - 在"账号管理"页面可以看到:
     * **数据库用户名**: 创建的管理员账号
     * **密码**: 如果忘记可以重置

   - 在"数据库管理"页面可以看到:
     * **数据库名称**: 已创建的数据库列表

### 方法二: 使用阿里云CLI查询 (高级)

```bash
# 安装阿里云CLI
# 查询RDS实例列表
aliyun rds DescribeDBInstances --RegionId cn-beijing

# 查询具体实例详情
aliyun rds DescribeDBInstanceAttribute --DBInstanceId <实例ID>
```

## 当前环境数据库配置

### 本地测试环境 (已完成)
```env
DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=baiguoyuan2025
DB_NAME=baiguoyuan_sentiment
DB_CHARSET=utf8mb4
DB_DIALECT=postgresql
```

### 云端生产环境 (待配置)
```env
# 请根据阿里云控制台查询到的信息填写
DB_HOST=<阿里云数据库内网地址>
DB_PORT=<端口号: 3306或5432>
DB_USER=<数据库用户名>
DB_PASSWORD=<数据库密码>
DB_NAME=<数据库名称>
DB_CHARSET=utf8mb4
DB_DIALECT=<mysql 或 postgresql>
```

## 重要提示

1. **使用内网地址还是公网地址?**
   - 如果ECS和数据库在同一地域(都在华北2-北京): 使用**内网地址** (免费、速度快、更安全)
   - 如果不在同一地域: 需要使用公网地址(收费)

2. **安全组配置**
   - 确保数据库实例的安全组允许ECS的IP访问
   - 如果使用内网地址,通常默认已配置
   - 如果使用公网地址,需要在数据库白名单中添加 `101.201.214.42` 或 `0.0.0.0/0`

3. **字符集**
   - 建议使用 `utf8mb4` 以支持完整的Unicode字符(包括emoji)
   - 创建数据库时指定: `CREATE DATABASE baiguoyuan_sentiment CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;`

4. **连接测试**
   - MySQL测试: `mysql -h <host> -P <port> -u <user> -p`
   - PostgreSQL测试: `psql -h <host> -p <port> -U <user> -d <database>`

## 数据库初始化 (云端首次部署)

本项目使用的是 SQLite/PostgreSQL/MySQL 兼容的 SQLAlchemy ORM,数据库表会在首次运行时自动创建。

如果需要手动初始化:

```bash
# 在服务器上
cd /root/BettaFish-test
source venv/bin/activate
python -c "from config import settings; print(settings.DB_DIALECT, settings.DB_HOST)"
```

## 常见问题

**Q: 数据库连接失败怎么办?**
A: 检查以下几点:
1. 数据库实例是否正在运行
2. 安全组规则是否正确
3. 用户名密码是否正确
4. 网络是否可达 (ping/telnet测试)

**Q: 本地SQLite数据需要迁移吗?**
A: 本地 `baiguoyuan_sentiment.db` 是测试数据,通常不需要迁移。云端会重新抓取数据。

**Q: 如何查看当前配置?**
A: 在项目根目录执行:
```bash
python -c "from config import settings; import json; print(json.dumps({k:v for k,v in settings.model_dump().items() if 'DB_' in k}, indent=2, ensure_ascii=False))"
```

---
最后更新: 2025-11-07
