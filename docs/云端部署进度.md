# 百果园舆情系统 - 云端部署进度

**部署日期**: 2025-11-07
**服务器**: 101.201.214.42 (阿里云 ECS - 华北2北京)
**操作系统**: Ubuntu 22.04.5 LTS

---

## ✅ 已完成的任务

### 1. 本地代码准备
- ✅ 检查本地代码Git状态 - 代码已是最新版本
- ✅ 创建数据库配置指南文档 (`docs/数据库配置指南.md`)
- ✅ 打包代码并排除不必要文件(.git, venv, *.db等)

### 2. 服务器环境配置
- ✅ 测试服务器网络连通性 (ping通)
- ✅ 安装Python 3.11.14 (通过PPA deadsnakes)
- ✅ 安装系统依赖: git, curl, python3-pip, python3.11-venv, python3.11-dev

### 3. 代码部署
- ✅ 由于GitHub网络问题,改用本地打包上传方式
- ✅ 代码已上传并解压到 `/root/BettaFish-test/`
- ✅ 创建Python 3.11虚拟环境 (`/root/BettaFish-test/venv`)
- ✅ 升级pip到最新版本 (25.3)
- 🔄 正在安装项目依赖 (requirements.txt) - 进行中...

### 4. 配置文件准备
- ✅ 创建.env配置文件模板并上传到服务器
- ⚠️ 数据库配置暂用本地PostgreSQL配置 (等待阿里云数据库信息)

### 5. 安全组配置
- ⚠️ 需要在阿里云控制台手动添加以下端口:
  - **5000** - Streamlit审核页面
  - **5001** - Flask主应用 (如果app.py使用5001端口)

---

## ⏳ 待完成的任务

### 1. 获取阿里云数据库信息 (重要!)
需要从阿里云控制台获取以下信息:
```
DB_HOST=<数据库内网地址>        # 例: rm-xxxxx.mysql.rds.aliyuncs.com
DB_PORT=<端口号>                # 3306(MySQL) 或 5432(PostgreSQL)
DB_USER=<数据库用户名>
DB_PASSWORD=<数据库密码>
DB_NAME=<数据库名称>           # 建议: baiguoyuan_sentiment
DB_DIALECT=<mysql或postgresql>
```

**如何查看?** 参考 `docs/数据库配置指南.md` 或根目录的 `查看阿里云数据库信息步骤.txt`

### 2. 更新服务器.env配置
获得数据库信息后,需要更新 `/root/BettaFish-test/.env` 文件中的数据库配置部分。

### 3. 添加安全组规则
在阿里云ECS控制台 -> 安全组 -> 添加入方向规则:
- 端口范围: 5000/5000, 协议: TCP, 授权对象: 0.0.0.0/0 (或指定IP)
- 端口范围: 5001/5001, 协议: TCP, 授权对象: 0.0.0.0/0 (或指定IP)

### 4. 首次启动测试
完成依赖安装后:
```bash
cd /root/BettaFish-test
source venv/bin/activate

# 测试Flask主应用
python app.py

# 测试Streamlit审核页 (新终端)
streamlit run baiguoyuan_review_app.py --server.address 0.0.0.0 --server.port 5000
```

### 5. 访问验证
- Streamlit审核页: http://101.201.214.42:5000
- Flask主站: http://101.201.214.42:5001 (或app.py设置的端口)

---

## 📋 服务器目录结构

```
/root/
├── BettaFish-test/              # 项目主目录
│   ├── venv/                    # Python 3.11虚拟环境
│   ├── .env                     # 环境配置文件
│   ├── app.py                   # Flask主应用
│   ├── baiguoyuan_review_app.py # Streamlit审核页
│   ├── requirements.txt         # 依赖列表
│   ├── docs/                    # 文档目录
│   │   └── 数据库配置指南.md
│   └── (其他项目文件...)
├── baiguoyuan/                  # 旧版本目录(非Git仓库)
└── BettaFish-test.tar.gz        # 代码压缩包备份
```

---

## 🔧 端口分配

| 服务 | 端口 | 说明 |
|-----|------|------|
| Streamlit审核页 | 5000 | baiguoyuan_review_app.py |
| Flask主站 | 5001 | app.py (需确认) |
| SSH | 22 | 服务器远程登录 |
| HTTP | 80 | Nginx (如需要) |

---

## ⚠️ 重要提示

1. **数据库连接**:
   - 建议使用阿里云数据库的**内网地址** (免费、快速、安全)
   - 确保ECS和数据库在同一地域(华北2-北京)
   - 数据库字符集必须设为 `utf8mb4` 以支持emoji

2. **.env安全**:
   - `.env` 文件包含敏感信息,已在`.gitignore`中排除
   - 不要将.env文件提交到Git仓库

3. **端口冲突**:
   - 原流程说明Flask用5001,但app.py中写的是5000
   - 如需修改,编辑 `app.py` 最后的 `PORT = 5000` 行

4. **进程管理**:
   - 测试成功后,建议使用 `tmux`、`screen` 或 `systemd` 保持服务常驻
   - 或使用项目提供的 `server_start.sh` 脚本

---

## 📝 下一步操作清单

- [ ] 查看阿里云数据库连接信息
- [ ] 更新服务器.env文件的数据库配置
- [ ] 在阿里云控制台添加安全组规则(开放5000、5001端口)
- [ ] 等待依赖安装完成
- [ ] 启动服务并测试访问
- [ ] 配置进程守护(可选)
- [ ] 配置定时爬虫任务(可选)

---

**联系方式**: 如有问题,请检查 `docs/` 目录下的相关文档或查看项目README。
